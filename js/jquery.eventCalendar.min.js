/*! @license: jquery.eventCalendar.js
    @author:  Jaime Fernandez (@vissit)
    @company: Paradigma Tecnologico (@paradigmate)
    @version: 0.54
    @date:    18-04-2013
*/
!function(e){"use strict";e.eventCalendar=function(t,n){var a=e(t),s=this,i="300",r={},l=function(t,n,i){var r,l,o=e("<div class='eventsCalendar-slider'></div>"),v=e("<div class='eventsCalendar-monthWrap'></div>"),h=e("<div class='eventsCalendar-currentTitle'><a href='#' class='monthTitle'></a></div>"),c=e("<a href='#' class='arrow prev'><span>"+s.settings.textPrevious+"</span></a><a href='#' class='arrow next'><span>"+s.settings.textNext+"</span></a>"),u=e("<ul class='eventsCalendar-daysList'></ul>"),p=new Date;if(a.find(".eventsCalendar-slider").size()?a.find(".eventsCalendar-slider").append(v):(a.prepend(o),o.append(v)),a.find(".eventsCalendar-monthWrap.currentMonth").removeClass("currentMonth").addClass("oldMonth"),v.addClass("currentMonth").append(h,u),"current"===t)r=p.getDate(),o.append(c);else{p=new Date(a.attr("data-current-year"),a.attr("data-current-month"),1,0,0,0),r=0;var g=1;"prev"===t&&(g=-1),p.setMonth(p.getMonth()+g);var f=new Date;p.getMonth()===f.getMonth()&&(r=f.getDate())}var n=p.getFullYear(),y=(new Date).getFullYear(),i=p.getMonth();"current"!=t&&d(s.settings.eventsLimit,n,i,!1,t),a.attr("data-current-month",i).attr("data-current-year",n),h.find(".monthTitle").html(s.settings.monthNames[i]+" "+n);var D=32-new Date(n,i,32).getDate(),m=[];if(s.settings.showDayAsWeeks){u.addClass("showAsWeek");var C;if(s.settings.showDayNameInCalendar)for(u.addClass("showDayNames"),C=0,s.settings.startWeekOnMonday&&(C=1);7>C;C++)m.push('<li class="eventsCalendar-day-header">'+s.settings.dayNamesShort[C]+"</li>"),6===C&&s.settings.startWeekOnMonday&&m.push('<li class="eventsCalendar-day-header">'+s.settings.dayNamesShort[0]+"</li>");var w=new Date(n,i,1),M=w.getDay();for(s.settings.startWeekOnMonday&&(M=w.getDay()-1),0>M&&(M=6),C=M;C>0;C--)m.push('<li class="eventsCalendar-day empty"></li>')}for(l=1;D>=l;l++){var T="";r>0&&l===r&&n===y&&(T="today"),m.push('<li id="dayList_'+l+'" rel="'+l+'" class="eventsCalendar-day '+T+'"><a href="#">'+l+"</a></li>")}u.append(m.join("")),o.css("height",v.height()+"px")},d=function(t,n,i,l,d){var t=t||0,n=n||"",l=l||"";if("undefined"!=typeof i)var i=i;else var i="";a.find(".eventsCalendar-loading").fadeIn(),s.settings.jsonData?(s.settings.cacheJson=!0,r=g(s.settings.jsonData),o(r,t,n,i,l,d)):s.settings.cacheJson&&d?o(r,t,n,i,l,d):e.getJSON(s.settings.eventsjson+"?limit="+t+"&year="+n+"&month="+i+"&day="+l,function(e){r=g(e),o(r,t,n,i,l,d)}).error(function(){u("error getting json: ")}),a.find(".current").removeClass("current"),l>""&&a.find("#dayList_"+l).addClass("current")};s.highlightMultiDayEvents=function(e,t){for(var n=new Date(parseInt(e.startDate,10)),s=new Date(parseInt(e.endDate,10)),i=parseInt(a.attr("data-current-year"),10),r=parseInt(a.attr("data-current-month"),10);n.compareTo(s)<=0;)n.getFullYear()===i&&n.getMonth()===r&&t(n.getDate()),n.addDays(1)},s.highlightSingleDayEvents=function(e,t){var n=a.attr("data-current-year"),i=a.attr("data-current-month");s.eventIsToday(e,n,i,"")&&t(parseInt(e.eventDay,10))},s.highlightCalenderDays=function(e,t){e&&t&&(e.recur?e.recur.split("_"):[],e.eventType===s.EventTypes.MULTI.name?s.highlightMultiDayEvents(e,t):s.highlightSingleDayEvents(e,t))};var o=function(t,n,i,r,l,d){var o="-="+s.directionLeftMove,v="auto",u=a.find(".eventsCalendar-list-wrap .eventsCalendar-subtitle");d?(""!=l?u.html(s.settings.textEventHeaderPrefix+s.settings.monthNames[r]+" "+c(l)+" "+s.settings.textEventHeaderSuffix):u.html(s.settings.textEventHeaderPrefix+s.settings.monthNames[r]+" "+s.settings.textEventHeaderSuffix),"prev"===d?o="+="+s.directionLeftMove:("day"===d||"month"===d)&&(o="+=0",v=0)):(u.html(s.settings.textNextEvents),v="auto",o="-=0"),a.find(".eventsCalendar-list").animate({opacity:s.settings.moveOpacity,left:o,height:v},s.settings.moveSpeed,function(){a.find(".eventsCalendar-list").css({left:0,height:"auto"}).hide();var d=[];if(t=e(t).sort(h),t.length){var o="";s.settings.showDescription||(o="hidden");var v="_self";s.settings.openEventInNewWindow&&(v="_target");var c=0;e.each(t,function(e,t){if((0===n||n>c)&&s.eventIsCurrent(t,i,r,l))if(r===!1&&t.eventDate<new Date);else{var h=t.eventDay+"/"+t.eventMonthToShow+"/"+t.eventYear,u=s.eventIsToday(t,i,r,l)?"current":"";if(t.url)var p='<a href="'+t.url+'" target="'+v+'" class="eventTitle '+u+'">'+t.title+"</a>";else var p='<span class="eventTitle '+u+'">'+t.title+"</span>";d.push('<li id="'+e+'" class="'+t.classDetail+'"><time datetime="'+t.eventDate+'"><em>'+h+"</em><small>"+t.eventHour+":"+t.eventMinute+"</small></time>"+p+'<div class="eventDesc '+o+'">'+t.description+"</div></li>"),c++}s.highlightCalenderDays(t,function(e){a.find(".currentMonth .eventsCalendar-daysList #dayList_"+e).addClass("dayWithEvents")})})}d.length||d.push('<li class="eventsCalendar-noEvents"><p>'+s.settings.textNoEvents+"</p></li>"),a.find(".eventsCalendar-loading").hide(),a.find(".eventsCalendar-list").html(d.join("")),s.settings.collapsible&&a.find(".eventDesc").hide(),a.find(".eventsCalendar-list").animate({opacity:1,height:"toggle"},s.settings.moveSpeed)}),f()},v=function(){a.find(".arrow").click(function(t){t.preventDefault();var n;e(this).hasClass("next")?(l("next"),n="-="+i):(l("prev"),n="+="+i),a.find(".eventsCalendar-monthWrap.oldMonth").animate({opacity:s.settings.moveOpacity,left:n},s.settings.moveSpeed,function(){a.find(".eventsCalendar-monthWrap.oldMonth").remove()})})},h=function(e,t){var n=e.eventType===s.EventTypes.MULTI.name?e.startDate:e.date,a=t.eventType===s.EventTypes.MULTI.name?t.startDate:t.date;return s.settings.sortAscending?n.toLowerCase()>a.toLowerCase()?1:-1:n.toLowerCase()<a.toLowerCase()?1:-1},c=function(e){var t,n=e.length,a=e.charAt(n-1);return t=2===n&&"1"===e.charAt(0)?"th":"1"===a?"st":"2"===a?"nd":"3"===a?"rd":"th",e+t},u=function(e){a.find(".eventsCalendar-list-wrap").html("<span class='eventsCalendar-loading error'>"+e+" "+s.settings.eventsjson+"</span>")},p=function(e,t,n,a,s){var i=0,r=0,l=0;return""!=n&&(i+=1e4*e.getFullYear(),r+=1e4*t.getFullYear(),l+=1e4*parseInt(n,10)),a!==!1&&(i+=100*e.getMonth(),r+=100*t.getMonth(),l+=100*a),""!=s&&(i+=e.getDate(),r+=t.getDate(),l+=parseInt(s,10)),l>=i&&r>=l};s.EventTypes={SINGLE:{value:0,name:"single"},MULTI:{value:1,name:"multi"}},Object.freeze&&Object.freeze(s.EventTypes),s.settings={},s.eventIsToday=function(e,t,n,a){var i=e.eventType===s.EventTypes.MULTI.name?new Date(parseInt(e.startDate,10)):new Date(parseInt(e.date,10)),r=e.eventType===s.EventTypes.MULTI.name?new Date(parseInt(e.endDate,10)):new Date(parseInt(e.date,10));return p(i,r,t,n,a)},s.eventIsCurrent=function(e,t,n,a){var s=e.startDate?new Date(parseInt(e.startDate,10)):new Date(parseInt(e.date,10)),i=e.endDate?new Date(parseInt(e.endDate,10)):new Date(parseInt(e.date,10));return p(s,i,t,n,a)};var g=function(t){return t.length&&e.each(t,function(e,t){t.eventType=!t.eventType||t.eventType.length<1?s.EventTypes.SINGLE.name:t.eventType.toLowerCase(),(!t.classDetail||t.classDetail.length<1)&&(t.classDetail=t.type),t.eventType==s.EventTypes.MULTI.name?t.endDate||(t.endDate=t.startDate):(t.startDate||(t.startDate=t.date),t.endDate||(t.endDate=t.date));var n=t.date;if((!n||n.length<1)&&(n=t.startDate),"human"==s.settings.jsonDateFormat){var a=n.split(" "),i=a[0].split("-"),r=a[1].split(":");t.eventYear=i[0],t.eventMonth=parseInt(i[1],10)-1,t.eventDay=parseInt(i[2],10),t.eventMonthToShow=parseInt(t.eventMonth,10)+1,t.eventHour=r[0],t.eventMinute=r[1],t.eventDate=new Date(t.eventYear,t.eventMonth,t.eventDay,t.eventHour,t.eventMinute,0)}else{var i=new Date(parseInt(n,10));t.eventDate=i,t.eventYear=i.getFullYear(),t.eventMonth=i.getMonth(),t.eventDay=i.getDate(),t.eventMonthToShow=t.eventMonth+1,t.eventHour=i.getHours(),t.eventMinute=i.getMinutes()}parseInt(t.eventMinute,10)<=9&&(t.eventMinute="0"+parseInt(t.eventMinute,10))}),t},f=function(){i=a.width(),a.find(".eventsCalendar-monthWrap").width(a.width()+"px"),a.find(".eventsCalendar-list-wrap").width(a.width()+"px")};s._initialiseCalendarWidth=function(){f(),e(window).resize(function(){f()})},s._initialiseContentSrolling=function(){s.settings.eventsScrollable&&a.find(".eventsCalendar-list-content").addClass("scrollable")},s._initialiseLoadingMessage=function(){a.addClass("eventCalendar-wrap").append("<div class='eventsCalendar-list-wrap'><p class='eventsCalendar-subtitle'></p><span class='eventsCalendar-loading'>loading...</span><div class='eventsCalendar-list-content'><ul class='eventsCalendar-list'></ul></div></div>")};var y=function(){s.settings=e.extend({},e.fn.eventCalendar.defaults,n),s._initialiseLoadingMessage(),s._initialiseContentSrolling(),s._initialiseCalendarWidth(),l("current");var t=a.attr("data-current-year"),i=a.attr("data-current-month"),r=new Date,o=""+r.getDate();s.settings.initialEventList&&"day"===s.settings.initialEventList?d(s.settings.eventsLimit,t,i,o,"day"):s.settings.initialEventList&&"month"===s.settings.initialEventList?d(s.settings.eventsLimit,t,i,!1,"month"):d(s.settings.eventsLimit,!1,!1,!1,!1),v(),a.on("click",".eventsCalendar-day a",function(t){t.preventDefault();var n=a.attr("data-current-year"),s=a.attr("data-current-month"),i=e(this).parent().attr("rel");d(!1,n,s,i,"day")}),a.on("click",".monthTitle",function(e){e.preventDefault();var t=a.attr("data-current-year"),n=a.attr("data-current-month");d(s.settings.eventsLimit,t,n,!1,"month")}),a.find(".eventsCalendar-list").on("click",".eventTitle",function(t){if(s.settings.collapsible&&s.settings.showDescription){t.preventDefault();var n=e(this).parent().find(".eventDesc");if(!n.find("a").size()){var i=e(this).attr("href"),r=e(this).attr("target");i&&i.length>0&&n.append('<a href="'+i+'" target="'+r+'" class="bt">'+s.settings.textGoToEventUrl+"</a>")}n.is(":visible")?n.slideUp():(s.settings.onlyOneDescription&&a.find(".eventDesc").slideUp(),n.slideDown())}})};y()},e.fn.eventCalendar=function(t){return this.each(function(){var n=e(this);if(!n.data("eventCalendar")){var a=new e.eventCalendar(this,t);n.data("eventCalendar",a)}})},e.fn.eventCalendar.eventRecurrence=function(t){var n=this,a=function(){n.type="none",n.interval=0},s=function(){a()},i=function(){if(a(),t&&t.type){var i=t.type.toLowerCase();if("none"!==i)return e.inArray(i,["day","week","month","year"])<0?(s(),void 0):(n.type=i,n.interval=t.interval?parseInt(t.interval,10):0,!n.interval||n.interval<1?(s(),void 0):void 0)}};return i(),this},e.fn.eventCalendar.defaults={eventsJson:"js/events.json",jsonDateFormat:"timestamp",jsonData:"",cacheJson:!0,sortAscending:!0,eventsLimit:4,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],textEventHeaderPrefix:"",textEventHeaderSuffix:"events:",textNoEvents:"There are no events in this period",textNext:"next",textPrevious:"prev",textNextEvents:"Next events:",textGoToEventUrl:"See the event",showDayAsWeeks:!0,startWeekOnMonday:!0,showDayNameInCalendar:!0,showDescription:!1,collapsible:!1,onlyOneDescription:!0,openEventInNewWindow:!1,eventsScrollable:!1,initialEventList:!1,currentDate:new Date,moveSpeed:500,moveOpacity:.15}}(jQuery);