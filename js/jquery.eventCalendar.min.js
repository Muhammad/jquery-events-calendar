/*! @license: jquery.eventCalendar.js
    @author:  Jaime Fernandez (@vissit)
    @company: Paradigma Tecnologico (@paradigmate)
    @version: 0.54
    @date:    18-04-2013
*/
!function(e){"use strict";e.eventRecurrence=function(t,n){var a=this,r=!1,s=function(){a.type="none",a.interval=0},i=function(e){e&&n&&n(e),s(),r=!0},l=function(){if(s(),!t||!t.type)return i("No recurrence data provided"),void 0;var n=t.type.toLowerCase();return"none"!==n?e.inArray(n,["day","week","month","year"])<0?(i("Invalid recurrence type: "+n),void 0):(a.type=n,a.interval=t.interval?parseInt(t.interval,10):0,!a.interval||a.interval<1?(i("Invalid recurrence interval: "+a.interval),void 0):void 0):void 0};l()},e.eventItem=function(t,n){var a=this,r=0,s=!1,i=function(e){if(0>e)return null;if(e>0&&(!a.recurrence||"none"===a.recurrence.type))return null;for(var t=new Date(a.date),n=new Date(a.startDate),r=new Date(a.endDate),s=0;e>s;){switch(a.recurrence.type){case"day":t=t?t.addDays(a.recurrence.interval):null,n=n?n.addDays(a.recurrence.interval):null,r=r?r.addDays(a.recurrence.interval):null;break;case"week":t=t?t.addWeeks(a.recurrence.interval):null,n=n?n.addWeeks(a.recurrence.interval):null,r=r?r.addWeeks(a.recurrence.interval):null;break;case"month":t=t?t.addMonths(a.recurrence.interval):null,n=n?n.addMonths(a.recurrence.interval):null,r=r?r.addMonths(a.recurrence.interval):null;break;case"year":t=t?t.addYears(a.recurrence.interval):null,n=n?n.addYears(a.recurrence.interval):null,r=r?r.addYears(a.recurrence.interval):null}s+=1}return{eventType:a.type,date:t,startDate:n,endDate:r,eventDay:n.getDate()}},l=function(){a.type="none",a.recurrence=null},d=function(e){e&&n&&n(e),l(),s=!0},v=function(){if(l(),!t)return d("No event data provided"),void 0;var n=t.eventType?t.eventType.toLowerCase():"single";return e.inArray(n,["single","multi"])<0?(d("Invalid event type: "+n),void 0):(a.type=n,a.recurrence=new e.eventRecurrence(t.recurrence),a.date=t.date?new Date(parseInt(t.date,10)):null,a.startDate=t.startDate?new Date(parseInt(t.startDate,10)):null,a.endDate=t.endDate?new Date(parseInt(t.endDate,10)):null,a.eventDay=t.eventDay,void 0)};a.getFirstEvent=function(){return r=0,i(0)},a.getNextEvent=function(e){return r+=1,r>=e?null:i(r)},v()},e.eventCalendar=function(t,n){var a=e(t),r=this,s="300",i={},l=function(t,n,s){var i,l,v=e("<div class='eventsCalendar-slider'></div>"),o=e("<div class='eventsCalendar-monthWrap'></div>"),c=e("<div class='eventsCalendar-currentTitle'><a href='#' class='monthTitle'></a></div>"),u=e("<a href='#' class='arrow prev'><span>"+r.settings.textPrevious+"</span></a><a href='#' class='arrow next'><span>"+r.settings.textNext+"</span></a>"),h=e("<ul class='eventsCalendar-daysList'></ul>"),p=new Date;if(a.find(".eventsCalendar-slider").size()?a.find(".eventsCalendar-slider").append(o):(a.prepend(v),v.append(o)),a.find(".eventsCalendar-monthWrap.currentMonth").removeClass("currentMonth").addClass("oldMonth"),o.addClass("currentMonth").append(c,h),"current"===t)i=p.getDate(),v.append(u);else{p=new Date(a.attr("data-current-year"),a.attr("data-current-month"),1,0,0,0),i=0;var g=1;"prev"===t&&(g=-1),p.setMonth(p.getMonth()+g);var f=new Date;p.getMonth()===f.getMonth()&&(i=f.getDate())}var n=p.getFullYear(),y=(new Date).getFullYear(),s=p.getMonth();"current"!=t&&d(r.settings.eventsLimit,n,s,!1,t),a.attr("data-current-month",s).attr("data-current-year",n);var D=new Date(n,s,i,0,0,0);c.find(".monthTitle").html(D.toString(r.settings.textCalendarTitle));var m=32-new Date(n,s,32).getDate(),w=[];if(r.settings.showDayAsWeeks){h.addClass("showAsWeek");var C;if(r.settings.showDayNameInCalendar)for(h.addClass("showDayNames"),C=r.settings.startWeekOnMonday?1:0;7>C;C+=1)w.push('<li class="eventsCalendar-day-header">'+r.settings.dayNamesShort[C]+"</li>"),6===C&&r.settings.startWeekOnMonday&&w.push('<li class="eventsCalendar-day-header">'+r.settings.dayNamesShort[0]+"</li>");var M=new Date(n,s,1),T=M.getDay();for(r.settings.startWeekOnMonday&&(T=M.getDay()-1),0>T&&(T=6),C=T;C>0;C--)w.push('<li class="eventsCalendar-day empty"></li>')}for(l=1;m>=l;l++){var I="";i>0&&l===i&&n===y&&(I="today"),w.push('<li id="dayList_'+l+'" rel="'+l+'" class="eventsCalendar-day '+I+'"><a href="#">'+l+"</a></li>")}h.append(w.join("")),v.css("height",o.height()+"px")},d=function(t,n,s,l,d){var t=t||0,n=n||"",l=l||"";if("undefined"!=typeof s)var s=s;else var s="";a.find(".eventsCalendar-loading").fadeIn(),r.settings.jsonData?(r.settings.cacheJson=!0,i=p(r.settings.jsonData),v(i,t,n,s,l,d)):r.settings.cacheJson&&d?v(i,t,n,s,l,d):e.getJSON(r.settings.eventsjson+"?limit="+t+"&year="+n+"&month="+s+"&day="+l,function(e){i=p(e),v(i,t,n,s,l,d)}).error(function(){u("error getting json: ")}),a.find(".current").removeClass("current"),l>""&&a.find("#dayList_"+l).addClass("current")};r.highlightMultiDayEvents=function(e,t){for(var n=new Date(e.startDate),r=new Date(e.endDate),s=parseInt(a.attr("data-current-year"),10),i=parseInt(a.attr("data-current-month"),10);n.compareTo(r)<=0;)n.getFullYear()===s&&n.getMonth()===i&&t(n.getDate()),n.addDays(1)},r.highlightSingleDayEvents=function(e,t){var n=a.attr("data-current-year"),s=a.attr("data-current-month");r.eventIsToday(e,n,s,"")&&t(parseInt(e.eventDay,10))},r.highlightCalenderDays=function(t,n){if(t&&n)for(var a=new e.eventItem(t),s=a.getFirstEvent();s;)s.eventType===r.EventTypes.MULTI.name?r.highlightMultiDayEvents(s,n):r.highlightSingleDayEvents(s,n),s=a.getNextEvent(r.settings.defaultRecurTimes)};var v=function(t,n,s,i,l,d){var v="-="+r.directionLeftMove,o="auto",u=a.find(".eventsCalendar-list-wrap .eventsCalendar-subtitle");if(d){var h=new Date(s,i,l,0,0,0),p=""!==l?h.toString(r.settings.textEventHeaderDayView):h.toString(r.settings.textEventHeaderMonthView);u.html(p),"prev"===d?v="+="+r.directionLeftMove:("day"===d||"month"===d)&&(v="+=0",o=0)}else u.html(r.settings.textNextEvents),o="auto",v="-=0";a.find(".eventsCalendar-list").animate({opacity:r.settings.moveOpacity,left:v,height:o},r.settings.moveSpeed,function(){a.find(".eventsCalendar-list").css({left:0,height:"auto"}).hide();var d=[];if(t=e(t).sort(c),t.length){var v="";r.settings.showDescription||(v="hidden");var o="_self";r.settings.openEventInNewWindow&&(o="_target");var u=0;e.each(t,function(e,t){if((0===n||n>u)&&r.eventIsCurrent(t,s,i,l))if(i===!1&&t.eventDate<new Date);else{var c=t.eventDay+"/"+t.eventMonthToShow+"/"+t.eventYear,h=r.eventIsToday(t,s,i,l)?"current":"";if(t.url)var p='<a href="'+t.url+'" target="'+o+'" class="eventTitle '+h+'">'+t.title+"</a>";else var p='<span class="eventTitle '+h+'">'+t.title+"</span>";d.push('<li id="'+e+'" class="'+t.classDetail+'"><time datetime="'+t.eventDate+'"><em>'+c+"</em><small>"+t.eventHour+":"+t.eventMinute+"</small></time>"+p+'<div class="eventDesc '+v+'">'+t.description+"</div></li>"),u++}r.highlightCalenderDays(t,function(e){a.find(".currentMonth .eventsCalendar-daysList #dayList_"+e).addClass("dayWithEvents")})})}d.length||d.push('<li class="eventsCalendar-noEvents"><p>'+r.settings.textNoEvents+"</p></li>"),a.find(".eventsCalendar-loading").hide(),a.find(".eventsCalendar-list").html(d.join("")),r.settings.collapsible&&a.find(".eventDesc").hide(),a.find(".eventsCalendar-list").animate({opacity:1,height:"toggle"},r.settings.moveSpeed)}),g()},o=function(){a.find(".arrow").click(function(t){t.preventDefault();var n;e(this).hasClass("next")?(l("next"),n="-="+s):(l("prev"),n="+="+s),a.find(".eventsCalendar-monthWrap.oldMonth").animate({opacity:r.settings.moveOpacity,left:n},r.settings.moveSpeed,function(){a.find(".eventsCalendar-monthWrap.oldMonth").remove()})})},c=function(e,t){var n=e.eventType===r.EventTypes.MULTI.name?e.startDate:e.date,a=t.eventType===r.EventTypes.MULTI.name?t.startDate:t.date;return r.settings.sortAscending?n.toLowerCase()>a.toLowerCase()?1:-1:n.toLowerCase()<a.toLowerCase()?1:-1},u=function(e){a.find(".eventsCalendar-list-wrap").html("<span class='eventsCalendar-loading error'>"+e+" "+r.settings.eventsjson+"</span>")},h=function(e,t,n,a,r){var s=0,i=0,l=0;return""!=n&&(s+=1e4*e.getFullYear(),i+=1e4*t.getFullYear(),l+=1e4*parseInt(n,10)),a!==!1&&(s+=100*e.getMonth(),i+=100*t.getMonth(),l+=100*a),""!=r&&(s+=e.getDate(),i+=t.getDate(),l+=parseInt(r,10)),l>=s&&i>=l};r.EventTypes={SINGLE:{value:0,name:"single"},MULTI:{value:1,name:"multi"}},Object.freeze&&Object.freeze(r.EventTypes),r.settings={},r.eventIsToday=function(e,t,n,a){var s=e.eventType===r.EventTypes.MULTI.name?e.startDate:e.date;s.getMonth||(s=new Date(parseInt(s,10)));var i=e.eventType===r.EventTypes.MULTI.name?e.endDate:e.date;return i.getMonth||(i=new Date(parseInt(i,10))),h(s,i,t,n,a)},r.eventIsCurrent=function(e,t,n,a){var r=e.startDate?e.startDate:e.date;r.getMonth||(r=new Date(parseInt(r,10)));var s=e.endDate?e.endDate:e.date;return s.getMonth||(s=new Date(parseInt(s,10))),h(r,s,t,n,a)};var p=function(t){return t.length&&e.each(t,function(e,t){t.eventType=!t.eventType||t.eventType.length<1?r.EventTypes.SINGLE.name:t.eventType.toLowerCase(),(!t.classDetail||t.classDetail.length<1)&&(t.classDetail=t.type),t.eventType==r.EventTypes.MULTI.name?t.endDate||(t.endDate=t.startDate):(t.startDate||(t.startDate=t.date),t.endDate||(t.endDate=t.date));var n=t.date;if((!n||n.length<1)&&(n=t.startDate),"human"==r.settings.jsonDateFormat){var a=n.split(" "),s=a[0].split("-"),i=a[1].split(":");t.eventYear=s[0],t.eventMonth=parseInt(s[1],10)-1,t.eventDay=parseInt(s[2],10),t.eventMonthToShow=parseInt(t.eventMonth,10)+1,t.eventHour=i[0],t.eventMinute=i[1],t.eventDate=new Date(t.eventYear,t.eventMonth,t.eventDay,t.eventHour,t.eventMinute,0)}else{var s=new Date(parseInt(n,10));t.eventDate=s,t.eventYear=s.getFullYear(),t.eventMonth=s.getMonth(),t.eventDay=s.getDate(),t.eventMonthToShow=t.eventMonth+1,t.eventHour=s.getHours(),t.eventMinute=s.getMinutes()}parseInt(t.eventMinute,10)<=9&&(t.eventMinute="0"+parseInt(t.eventMinute,10))}),t},g=function(){s=a.width(),a.find(".eventsCalendar-monthWrap").width(a.width()+"px"),a.find(".eventsCalendar-list-wrap").width(a.width()+"px")};r._initialiseCalendarWidth=function(){g(),e(window).resize(function(){g()})},r._initialiseContentSrolling=function(){r.settings.eventsScrollable&&a.find(".eventsCalendar-list-content").addClass("scrollable")},r._initialiseLoadingMessage=function(){a.addClass("eventCalendar-wrap").append("<div class='eventsCalendar-list-wrap'><p class='eventsCalendar-subtitle'></p><span class='eventsCalendar-loading'>loading...</span><div class='eventsCalendar-list-content'><ul class='eventsCalendar-list'></ul></div></div>")};var f=function(){r.settings=e.extend({},e.fn.eventCalendar.defaults,n),r._initialiseLoadingMessage(),r._initialiseContentSrolling(),r._initialiseCalendarWidth(),l("current");var t=a.attr("data-current-year"),s=a.attr("data-current-month"),i=new Date,v=""+i.getDate();r.settings.initialEventList&&"day"===r.settings.initialEventList?d(r.settings.eventsLimit,t,s,v,"day"):r.settings.initialEventList&&"month"===r.settings.initialEventList?d(r.settings.eventsLimit,t,s,!1,"month"):d(r.settings.eventsLimit,!1,!1,!1,!1),o(),a.on("click",".eventsCalendar-day a",function(t){t.preventDefault();var n=a.attr("data-current-year"),r=a.attr("data-current-month"),s=e(this).parent().attr("rel");d(!1,n,r,s,"day")}),a.on("click",".monthTitle",function(e){e.preventDefault();var t=a.attr("data-current-year"),n=a.attr("data-current-month");d(r.settings.eventsLimit,t,n,!1,"month")}),a.find(".eventsCalendar-list").on("click",".eventTitle",function(t){if(r.settings.collapsible&&r.settings.showDescription){t.preventDefault();var n=e(this).parent().find(".eventDesc");if(!n.find("a").size()){var s=e(this).attr("href"),i=e(this).attr("target");s&&s.length>0&&n.append('<a href="'+s+'" target="'+i+'" class="bt">'+r.settings.textGoToEventUrl+"</a>")}n.is(":visible")?n.slideUp():(r.settings.onlyOneDescription&&a.find(".eventDesc").slideUp(),n.slideDown())}})};f()},e.fn.eventCalendar=function(t){return this.each(function(){var n=e(this);if(!n.data("eventCalendar")){var a=new e.eventCalendar(this,t);n.data("eventCalendar",a)}})},e.fn.eventCalendar.defaults={eventsJson:"js/events.json",jsonDateFormat:"timestamp",jsonData:"",cacheJson:!0,sortAscending:!0,eventsLimit:4,defaultRecurTimes:3,dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],textCalendarTitle:"MMMM yyyy",textEventHeaderDayView:"MMMM ddS even\\t\\s:",textEventHeaderMonthView:"MMMM even\\t\\s:",textNoEvents:"There are no events in this period",textNext:"next",textPrevious:"prev",textNextEvents:"Next events:",textGoToEventUrl:"See the event",showDayAsWeeks:!0,startWeekOnMonday:!0,showDayNameInCalendar:!0,showDescription:!1,collapsible:!1,onlyOneDescription:!0,openEventInNewWindow:!1,eventsScrollable:!1,initialEventList:!1,currentDate:new Date,moveSpeed:500,moveOpacity:.15}}(jQuery);