/**
 * @preserve: jquery.eventCalendar.js
 * @version:  0.60
 * @author:   Jaime Fernandez (@vissit)
 * @company:  Paradigma Tecnologico (@paradigmate)
 * @date:     2013-06-29
 * @website:  http://www.vissit.com/projects/eventCalendar/
 */
!function(e){"use strict";function t(t,n){var a=this,s=!1;a.type="none",a.interval=0;var r=function(){a.type="none",a.interval=0},i=function(e){e&&n&&n(e),r(),s=!0},l=function(){if(r(),!t||!t.type)return i("No recurrence data provided"),void 0;var n=t.type.toLowerCase();return"none"!==n?e.inArray(n,["day","week","month","year"])<0?(i("Invalid recurrence type: "+n),void 0):(a.type=n,a.interval=t.interval?parseInt(t.interval,10):0,!a.interval||a.interval<1?(i("Invalid recurrence interval: "+a.interval),void 0):void 0):void 0};a.getRecurrenceDate=function(e,t){if(t||(t=0),!e||0>t)return null;for(var n=new Date(e),s=0;t>s&&(n=a.getNextRecurrenceDate(n));)s+=1;return n},a.getNextRecurrenceDate=function(e){if(!e)return null;var t=new Date(e);switch(a.type){case"day":t=t.addDays(a.interval);break;case"week":t=t.addWeeks(a.interval);break;case"month":t=t.addMonths(a.interval);break;case"year":t=t.addYears(a.interval);break;default:t=null}return t},l()}function n(){var e=this;e.startDate=null,e.endDate=null,e.listingStartOffset=0,e.listingNumberOfDays=1,e.title=null,e.description=null,e.url=null,e.classEvent=null,e.classTitle=null,e.classDescription=null}function a(e,s,r){var i=this,l=0,o=!1;i.recurrence=null,i.startDate=null,i.endDate=null,i.listingStartOffset=0,i.listingNumberOfDays=1,i.title=null,i.description=null,i.url=null,i.classEvent=null,i.classTitle=null,i.classDescription=null;var d=function(e,t){if(0>l&&(l=0),l>0&&(!i.recurrence||"none"===i.recurrence.type))return null;var s=e||-1,r=t||-1,o=i.recurrence.getRecurrenceDate(i.startDate,l),d=Math.round((o-i.startDate)/1e3),c=new Date(i.endDate).addSeconds(d);if(o&&(s>=0||r>=0))for(;!a.datePeriodIsCurrent(o,c,s,r)&&(o=i.recurrence.getNextRecurrenceDate(o));)d=Math.round((o-i.startDate)/1e3),c=new Date(i.endDate).addSeconds(d);var v=null;return o&&(v=new n,v.startDate=o,v.endDate=c,v.listingStartOffset=i.listingStartOffset,v.listingNumberOfDays=i.listingNumberOfDays,v.title=i.title,v.description=i.description,v.url=i.url,v.classEvent=i.classEvent,v.classTitle=i.classTitle,v.classDescription=i.classDescription),v},c=function(){i.recurrence=null,i.startDate=null,i.endDate=null,i.listingStartOffset=0,i.listingNumberOfDays=1,i.title=null,i.description=null,i.url=null,i.classEvent=null,i.classTitle=null,i.classDescription=null},v=function(e){e&&r&&r(e),c(),o=!0},u=function(e,t){if(!e)return null;var n=null;return"object"==typeof e&&e.getMonth?n=new Date(e):"number"==typeof e?n=new Date(e):"string"==typeof e&&t&&(n="timestamp"===t.toLowerCase()?new Date(parseInt(e,10)):Date.parseExact(e,t)),n||(n=Date.parse(e)),n},f=function(){return c(),e?(i.recurrence=new t(e.recurrence),i.startDate=e.startDate?u(e.startDate,s):null,i.startDate||(i.startDate=e.date?u(e.date,s):null),i.endDate=e.endDate?u(e.endDate,s):u(i.startDate),i.listingStartOffset=e.listingStartOffset||0,i.listingNumberOfDays=e.listingNumberOfDays||1,i.title=e.title,i.description=e.description,i.url=e.url,i.classEvent=e.classEvent,i.classTitle=e.classTitle,i.classDescription=e.classDescription||e.type,void 0):(v("No event data provided"),void 0)};i.getFirstEventInstance=function(e,t){return l=0,d(e,t)},i.getNextEventInstance=function(e,t){return l+=1,d(e,t)},f()}function s(t,n){var s=this,r=e(t),i="300",l={},o=function(e){r.find(".eventsCalendar-list-wrap").html("<span class='eventsCalendar-loading error'>"+e+" "+s.settings.eventsjson+"</span>")},d=function(){i=r.width(),r.find(".eventsCalendar-monthWrap").width(r.width()+"px"),r.find(".eventsCalendar-list-wrap").width(r.width()+"px")},c=function(){d(),e(window).resize(function(){d()})},v=function(t,n,i,l,o,c){var v="-="+s.directionLeftMove,u="auto",f=r.find(".eventsCalendar-list-wrap .eventsCalendar-subtitle");if(c){var p=new Date(i,l,""!==o?o:1,0,0,0),g=""!==o?p.toString(s.settings.textEventHeaderDayView):p.toString(s.settings.textEventHeaderMonthView);f.html(g),"prev"===c?v="+="+s.directionLeftMove:("day"===c||"month"===c)&&(v="+=0",u=0)}else f.html(s.settings.textNextEvents),u="auto",v="-=0";r.find(".eventsCalendar-list").animate({opacity:s.settings.moveOpacity,left:v,height:u},s.settings.moveSpeed,function(){r.find(".eventsCalendar-list").css({left:0,height:"auto"}).hide();var d=[];if(t=e(t).sort(function(e,t){var n;return n=s.settings.sortAscending?e.startDate.toLowerCase()>t.startDate.toLowerCase()?1:-1:e.startDate.toLowerCase()<t.startDate.toLowerCase()?1:-1}),t.length){var c=0;e.each(t,function(e,t){var v=new a(t,s.settings.jsonDateFormat);s.addEventToCalendar(v,function(e,t){r.find(".currentMonth .eventsCalendar-daysList #dayList_"+t).addClass("dayWithEvents")},function(r){if(!(r.listingNumberOfDays<1||0!==n&&c>=n)){var v=r.startDate.clone();v=v.addDays(r.listingStartOffset);var u=v.clone();u=u.addDays(r.listingNumberOfDays-1);var f=""!==o?parseInt(o,10):-1,p=a.datePeriodIsCurrent(r.startDate,r.endDate,i,l,f);if(p||a.datePeriodIsCurrent(v,u,i,l,f)){var g=r.classEvent?' class="'+r.classEvent+'"':"",h=' class="eventTitle';h+=r.classTitle?" "+r.classTitle:"",h+=p?" current":"",h+='"';var D=' class="eventDescription';D+=r.classDescription?" "+r.classDescription:"",D+=s.settings.showDescription?"":" hidden",D+='"';var y,m=s.settings.openEventInNewWindow?"_target":"_self";y=r.url?'<a href="'+r.url+'" target="'+m+'"'+h+">"+r.title+"</a>":"<span"+h+">"+r.title+"</span>",d.push('<li id="'+e+'"'+g+">"+y+"<div"+D+">"+t.description+"</div></li>"),c+=1}}},i,l)})}d.length||d.push('<li class="eventsCalendar-noEvents"><p>'+s.settings.textNoEvents+"</p></li>"),r.find(".eventsCalendar-loading").hide(),r.find(".eventsCalendar-list").html(d.join("")),s.settings.collapsible&&r.find(".eventDescription").hide(),r.find(".eventsCalendar-list").animate({opacity:1,height:"toggle"},s.settings.moveSpeed)}),d()},u=function(t,n,a,i,d){var c=t||0,u=n||"",f=void 0!==a?a:"",p=i||"";r.find(".eventsCalendar-loading").fadeIn(),s.settings.jsonData?(s.settings.cacheJson=!0,l=s.settings.jsonData,v(l,c,u,f,p,d)):s.settings.cacheJson&&d?v(l,c,u,f,p,d):e.getJSON(s.settings.eventsjson+"?limit="+c+"&year="+u+"&month="+f+"&day="+p,function(e){l=e,v(l,c,u,f,p,d)}).error(function(){o("error getting json: ")}),r.find(".current").removeClass("current"),p>""&&r.find("#dayList_"+p).addClass("current")},f=function(t){var n,a=null;"current"===t?a=Date.today().moveToFirstDayOfMonth():(a=new Date(r.attr("data-current-year"),r.attr("data-current-month"),1,0,0,0),a="prev"===t?a.addMonths(-1):a.addMonths(1));var i=a.getFullYear(),l=a.getMonth();r.attr("data-current-month",l).attr("data-current-year",i);var o=e("<div class='eventsCalendar-slider'></div>"),d=e("<div class='eventsCalendar-monthWrap'></div>"),c=e("<div class='eventsCalendar-currentTitle'><a href='#' class='monthTitle'></a></div>"),v=e("<a href='#' class='arrow prev'><span>"+s.settings.textPrevious+"</span></a><a href='#' class='arrow next'><span>"+s.settings.textNext+"</span></a>"),f=e("<ul class='eventsCalendar-daysList'></ul>");r.find(".eventsCalendar-slider").size()?(o=r.find(".eventsCalendar-slider"),o.append(d)):(r.prepend(o),o.append(d),o.append(v)),r.find(".eventsCalendar-monthWrap.currentMonth").removeClass("currentMonth").addClass("oldMonth"),d.addClass("currentMonth").append(c,f),"current"!==t&&u(s.settings.eventsLimit,i,l,!1,t),c.find(".monthTitle").html(a.toString(s.settings.textCalendarTitle));var p=[];if(s.settings.showDayAsWeeks){if(f.addClass("showAsWeek"),s.settings.showDayNameInCalendar){f.addClass("showDayNames");var g=Date.today().moveToDayOfWeek(s.settings.startWeekOnMonday?1:0);for(n=0;7>n;n+=1)p.push('<li class="eventsCalendar-day-header">'+g.toString(s.settings.dayNameFormat)+"</li>"),g.addDays(1)}var h=a.getDay();for(s.settings.startWeekOnMonday&&(h-=1,0>h&&(h=6)),n=0;h>n;n+=1)p.push('<li class="eventsCalendar-day empty"></li>')}var D=Date.getDaysInMonth(a.getFullYear(),a.getMonth());for(n=1;D>=n;n+=1)p.push('<li id="dayList_'+n+'" rel="'+n+'" class="eventsCalendar-day"><a href="#">'+n+"</a></li>");f.append(p.join("")),o.height(d.height()+"px")};s.addEventToCalendar=function(e,t,n,a,s){if(e&&t)for(var r=a||-1,i=s||-1,l=e.getFirstEventInstance();l;){var o=new Date(l.startDate);for(n&&"function"==typeof n&&n(l);o.compareTo(l.endDate)<=0;)-1!==r&&o.getFullYear()!==r||-1!==i&&o.getMonth()!==i||t&&"function"==typeof t&&t(l,o.getDate()),o.addDays(1);l=e.getNextEventInstance()}},s.settings={};var p=function(){r.addClass("eventCalendar-wrap").append("<div class='eventsCalendar-list-wrap'><p class='eventsCalendar-subtitle'></p><span class='eventsCalendar-loading'>loading...</span><div class='eventsCalendar-list-content'><ul class='eventsCalendar-list'></ul></div></div>")},g=function(){s.settings.eventsScrollable&&r.find(".eventsCalendar-list-content").addClass("scrollable")},h=function(){r.find(".arrow").click(function(t){t.preventDefault();var n;e(this).hasClass("next")?(f("next"),n="-="+i):(f("prev"),n="+="+i),r.find(".eventsCalendar-monthWrap.oldMonth").animate({opacity:s.settings.moveOpacity,left:n},s.settings.moveSpeed,function(){r.find(".eventsCalendar-monthWrap.oldMonth").remove()})})},D=function(){s.settings=e.extend({},e.fn.eventCalendar.defaults,n),p(),g(),c(),f("current");var t=parseInt(r.attr("data-current-year"),10),a=parseInt(r.attr("data-current-month"),10),i=Date.today().getDate();s.settings.initialEventList&&"day"===s.settings.initialEventList?u(s.settings.eventsLimit,t,a,i,"day"):s.settings.initialEventList&&"month"===s.settings.initialEventList?u(s.settings.eventsLimit,t,a,!1,"month"):u(s.settings.eventsLimit,!1,!1,!1,!1),h(),r.on("click",".eventsCalendar-day a",function(t){t.preventDefault();var n=parseInt(r.attr("data-current-year"),10),a=parseInt(r.attr("data-current-month"),10),s=e(this).parent().attr("rel");u(!1,n,a,s,"day")}),r.on("click",".monthTitle",function(e){e.preventDefault();var t=r.attr("data-current-year"),n=r.attr("data-current-month");u(s.settings.eventsLimit,t,n,!1,"month")}),r.find(".eventsCalendar-list").on("click",".eventTitle",function(t){if(s.settings.collapsible&&s.settings.showDescription){t.preventDefault();var n=e(this).parent().find(".eventDescription");if(!n.find("a").size()){var a=e(this).attr("href"),i=e(this).attr("target");a&&a.length>0&&n.append('<a href="'+a+'" target="'+i+'" class="bt">'+s.settings.textGoToEventUrl+"</a>")}n.is(":visible")?n.slideUp():(s.settings.onlyOneDescription&&r.find(".eventDescription").slideUp(),n.slideDown())}})};D()}a.datePeriodIsCurrent=function(e,t,n,a,s){var r=0,i=0,l=0;return n>=0&&(r+=1e4*e.getFullYear(),i+=1e4*t.getFullYear(),l+=1e4*n),a>=0&&(r+=100*e.getMonth(),i+=100*t.getMonth(),l+=100*a),s>=0&&(r+=e.getDate(),i+=t.getDate(),l+=s),l>=r&&i>=l},e.fn.eventCalendar=function(t){return this.each(function(){var n=e(this);if(!n.data("eventCalendar")){var a=new s(this,t);n.data("eventCalendar",a)}})},e.fn.eventCalendar.defaults={eventsJson:"js/events.json",jsonDateFormat:"timestamp",jsonData:"",cacheJson:!0,sortAscending:!0,eventsLimit:4,dayNameFormat:"ddd",textCalendarTitle:"MMMM yyyy",textEventHeaderDayView:"MMMM ddS even\\t\\s:",textEventHeaderMonthView:"MMMM even\\t\\s:",textNoEvents:"There are no events in this period",textNext:"next",textPrevious:"prev",textNextEvents:"Next events:",textGoToEventUrl:"See the event",showDayAsWeeks:!0,startWeekOnMonday:!0,showDayNameInCalendar:!0,showDescription:!1,collapsible:!1,onlyOneDescription:!0,openEventInNewWindow:!1,eventsScrollable:!1,initialEventList:!1,currentDate:new Date,moveSpeed:500,moveOpacity:.15},e.EventRecurrence=t,e.EventInstance=n,e.EventItem=a,e.EventCalendar=s}(jQuery);