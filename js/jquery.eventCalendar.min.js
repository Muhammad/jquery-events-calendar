/**
 * @preserve: jquery.eventCalendar.js
 * @author:   Jaime Fernandez (@vissit)
 * @company:  Paradigma Tecnologico (@paradigmate)
 * @version:  1.01
 * @date:     2013-07-28
 * @website:  http://www.vissit.com/projects/eventCalendar/
 */
!function(e){"use strict";function t(t,n,a){var s=this,r=!1;s.type="none",s.interval=0,s.end="none",s._index=0;var i=function(){s.type="none",s.interval=0,s.end="none",s._index=0},l=function(e){e&&a&&a(e),i(),r=!0},d=function(){if(i(),!t||!t.type)return l("No recurrence data provided"),void 0;var a=t.type.toLowerCase();return"none"!==a?e.inArray(a,["day","week","month","year"])<0?(l("Invalid recurrence type: "+a),void 0):(s.type=a,s.interval=t.interval?parseInt(t.interval,10):0,!s.interval||s.interval<1?(l("Invalid recurrence interval: "+t.interval),void 0):(void 0===t.end?s.end="none":"object"==typeof t.end&&t.end.getMonth?s.end=t.end.clone():"number"==typeof t.end?s.end=parseInt(t.end,10):"string"==typeof t.end&&(s.end=t.end.toLowerCase(),""===s.end?s.end="none":"none"!==s.end&&(n&&(s.end="timestamp"===n.toLowerCase()?new Date(parseInt(t.end,10)):Date.parseExact(t.end,n)),s.end||(s.end=Date.parse(t.end)))),s.end?void 0:(l("Invalid end recurrence: "+t.end),void 0))):void 0};s.getRecurrenceDate=function(e,t){if(t||(t=0),!e||0>t)return null;var n=new Date(e);s._index=0;for(var a=0;t>a&&(n=s.getNextRecurrenceDate(n));)a+=1;return s._index=a,n},s.getNextRecurrenceDate=function(e){if(!e)return null;var t=new Date(e);switch(s.type){case"day":t=t.addDays(s.interval),s._index+=1;break;case"week":t=t.addWeeks(s.interval),s._index+=1;break;case"month":t=t.addMonths(s.interval),s._index+=1;break;case"year":t=t.addYears(s.interval),s._index+=1;break;default:t=null}return null!==t&&"none"!==s.end&&("object"==typeof s.end&&s.end.getMonth?t.isAfter(s.end)&&(t=null):"number"==typeof s.end&&s._index>=s.end&&(t=null)),t},d()}function n(){var e=this;e.startDate=null,e.endDate=null,e.listingStartOffset=0,e.listingNumberOfDays=1,e.title=null,e.description=null,e.url=null,e.classEvent=null,e.classTitle=null,e.classDescription=null}function a(e,s,r){var i=this,l=0,d=!1;i.recurrence=null,i.startDate=null,i.endDate=null,i.listingStartOffset=0,i.listingNumberOfDays=1,i.title=null,i.description=null,i.url=null,i.classEvent=null,i.classTitle=null,i.classDescription=null;var o=864e5,c=function(e,t){var n=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()),a=Date.UTC(t.getFullYear(),t.getMonth(),t.getDate());return Math.floor((a-n)/o)},v=function(e,t){var s;if(0>l&&(l=0),l>0&&(!i.recurrence||"none"===i.recurrence.type))return null;var r=void 0!==e?e:-1,d=void 0!==t?t:-1,o=i.recurrence.getRecurrenceDate(i.startDate,l);if(o){var v=c(i.startDate,o);if(s=new Date(i.endDate).addDays(v),o&&(r>=0||d>=0))for(;!a.datePeriodIsCurrent(o,s,r,d)&&(o=i.recurrence.getNextRecurrenceDate(o));)v=c(i.startDate,o),s=new Date(i.endDate).addDays(v)}var u=null;return o&&(u=new n,u.startDate=o,u.endDate=s,u.listingStartOffset=i.listingStartOffset,u.listingNumberOfDays=i.listingNumberOfDays,u.title=i.title,u.description=i.description,u.url=i.url,u.classEvent=i.classEvent,u.classTitle=i.classTitle,u.classDescription=i.classDescription),u},u=function(){i.recurrence=null,i.startDate=null,i.endDate=null,i.listingStartOffset=0,i.listingNumberOfDays=1,i.title=null,i.description=null,i.url=null,i.classEvent=null,i.classTitle=null,i.classDescription=null},f=function(e){e&&r&&r(e),u(),d=!0},g=function(e,t){if(!e)return null;var n=null;return"object"==typeof e&&e.getMonth?n=e.clone():"number"==typeof e?n=new Date(e):"string"==typeof e&&t&&(n="timestamp"===t.toLowerCase()?new Date(parseInt(e,10)):Date.parseExact(e,t)),n||(n=Date.parse(e)),n},p=function(){return u(),e?(i.recurrence=new t(e.recurrence,s),i.startDate=e.startDate?g(e.startDate,s):null,i.startDate||(i.startDate=e.date?g(e.date,s):null),i.endDate=e.endDate?g(e.endDate,s):g(i.startDate),i.listingStartOffset=e.listingStartOffset||0,i.listingNumberOfDays=e.listingNumberOfDays||1,i.title=e.title,i.description=e.description,i.url=e.url,i.classEvent=e.classEvent,i.classTitle=e.classTitle,i.classDescription=e.classDescription||e.type,void 0):(f("No event data provided"),void 0)};i.getFirstEventInstance=function(e,t){return l=0,v(e,t)},i.getNextEventInstance=function(e,t){return l+=1,v(e,t)},p()}function s(t,n){var s=this,r=e(t),i="300",l={},d=function(e){r.find(".eventsCalendar-list-wrap").html("<span class='eventsCalendar-loading error'>"+e+" "+s.settings.eventsjson+"</span>")},o=function(){i=r.width(),r.find(".eventsCalendar-monthWrap").width(r.width()+"px"),r.find(".eventsCalendar-list-wrap").width(r.width()+"px")},c=function(){o(),e(window).resize(function(){o()})},v=function(t,n,i,l,d,c){var v="-="+s.directionLeftMove,u="auto",f=""!==d?parseInt(d,10):-1,g=r.find(".eventsCalendar-list-wrap .eventsCalendar-subtitle");if(c){var p=new Date(i,l,""!==d?d:1,0,0,0),D=""!==d?p.toString(s.settings.textEventHeaderDayView):p.toString(s.settings.textEventHeaderMonthView);g.html(D),"prev"===c?v="+="+s.directionLeftMove:("day"===c||"month"===c)&&(v="+=0",u=0)}else g.html(s.settings.textNextEvents),u="auto",v="-=0";r.find(".eventsCalendar-list").animate({opacity:s.settings.moveOpacity,left:v,height:u},s.settings.moveSpeed,function(){r.find(".eventsCalendar-list").css({left:0,height:"auto"}).hide(),r.find(".dayWithEvents").removeClass("dayWithEvents");var d=[];if(t=e(t).sort(function(e,t){var n;return n=s.settings.sortAscending?e.startDate.toLowerCase()>t.startDate.toLowerCase()?1:-1:e.startDate.toLowerCase()<t.startDate.toLowerCase()?1:-1}),t.length){var o=0;e.each(t,function(e,t){var c=new a(t,s.settings.jsonDateFormat);s.addEventToCalendar(c,function(e,t){var n=r.find(".currentMonth .eventsCalendar-daysList #dayList_"+t);n.hasClass("dayWithEvents")||n.addClass("dayWithEvents")},function(a,r){if(0!==n&&o>=n)return!1;var i=a.classEvent?' class="'+a.classEvent+'"':"",l=' class="eventTitle';l+=a.classTitle?" "+a.classTitle:"",l+=r?" "+r:"",l+='"';var c=' class="eventDescription';c+=a.classDescription?" "+a.classDescription:"",c+=s.settings.showDescription?"":" hidden",c+='"';var v,u=s.settings.openEventInNewWindow?"_target":"_self";return v=a.url?'<a href="'+a.url+'" target="'+u+'"'+l+">"+a.title+"</a>":"<span"+l+">"+a.title+"</span>",d.push('<li id="'+e+'"'+i+">"+v+"<div"+c+">"+t.description+"</div></li>"),o+=1,!0},i,l,f)})}d.length||d.push('<li class="eventsCalendar-noEvents"><p>'+s.settings.textNoEvents+"</p></li>"),r.find(".eventsCalendar-loading").hide(),r.find(".eventsCalendar-list").html(d.join("")),s.settings.collapsible&&r.find(".eventDescription").hide(),r.find(".eventsCalendar-list").animate({opacity:1,height:"toggle"},s.settings.moveSpeed)}),o()},u=function(t,n,a,i,o){var c=t||0,u=n||"",f=void 0!==a?a:"",g=i||"";r.find(".eventsCalendar-loading").fadeIn(),s.settings.jsonData?(s.settings.cacheJson=!0,l=s.settings.jsonData,v(l,c,u,f,g,o)):s.settings.cacheJson&&o?v(l,c,u,f,g,o):e.getJSON(s.settings.eventsjson+"?limit="+c+"&year="+u+"&month="+f+"&day="+g,function(e){l=e,v(l,c,u,f,g,o)}).error(function(){d("error getting json: ")}),r.find(".current").removeClass("current"),g>""&&r.find("#dayList_"+g).addClass("current")},f=function(t){var n,a=null;"current"===t?a=s.settings.currentDate:(a=new Date(r.attr("data-current-year"),r.attr("data-current-month"),1,0,0,0),a="prev"===t?a.addMonths(-1):a.addMonths(1));var i=a.getFullYear(),l=a.getMonth();r.attr("data-current-month",l).attr("data-current-year",i);var d=e("<div class='eventsCalendar-slider'></div>"),o=e("<div class='eventsCalendar-monthWrap'></div>"),c=e("<div class='eventsCalendar-currentTitle'><a href='#' class='monthTitle'></a></div>"),v=e("<a href='#' class='arrow prev'><span>"+s.settings.textPrevious+"</span></a><a href='#' class='arrow next'><span>"+s.settings.textNext+"</span></a>"),f=e("<ul class='eventsCalendar-daysList'></ul>");r.find(".eventsCalendar-slider").size()?(d=r.find(".eventsCalendar-slider"),d.append(o)):(r.prepend(d),d.append(o),d.append(v)),r.find(".eventsCalendar-monthWrap.currentMonth").removeClass("currentMonth").addClass("oldMonth"),o.addClass("currentMonth").append(c,f),"current"!==t&&u(s.settings.eventsLimit,i,l,!1,t),c.find(".monthTitle").html(a.toString(s.settings.textCalendarTitle));var g=[];if(s.settings.showDayAsWeeks){if(f.addClass("showAsWeek"),s.settings.showDayNameInCalendar){f.addClass("showDayNames");var p=Date.today().moveToDayOfWeek(s.settings.startWeekOnMonday?1:0);for(n=0;7>n;n+=1)g.push('<li class="eventsCalendar-day-header">'+p.toString(s.settings.dayNameFormat)+"</li>"),p.addDays(1)}var D=a.clone().moveToFirstDayOfMonth().getDay();for(s.settings.startWeekOnMonday&&(D-=1,0>D&&(D=6)),n=0;D>n;n+=1)g.push('<li class="eventsCalendar-day empty"></li>')}var h=Date.getDaysInMonth(a.getFullYear(),a.getMonth());for(n=1;h>=n;n+=1)g.push('<li id="dayList_'+n+'" rel="'+n+'" class="eventsCalendar-day"><a href="#">'+n+"</a></li>");f.append(g.join("")),d.height(o.height()+"px")};s.addEventToCalendar=function(e,t,n,r,i,l){function d(){return n&&"function"==typeof n?y&&s.settings.groupEvents?!1:h||a.datePeriodIsCurrent(c,v,f,g,p)?!s.settings.allowPartialEvents||1>p||D.between(s.settings.startDate,s.settings.endDate):!1:!1}function o(){return t&&"function"==typeof t?-1!==f&&u.getFullYear()!==f?!1:-1!==g&&u.getMonth()!==g?!1:!s.settings.allowPartialEvents||u.between(s.settings.startDate,s.settings.endDate):!1}if(e&&t){var c,v,u,f=void 0!==r?r:-1,g=void 0!==i?i:-1,p=void 0!==l?l:-1,D=0>f||0>g||0>p?s.settings.startDate:new Date(f,g,p,0,0,0),h=!1,y=!1,m=e.getFirstEventInstance();if(m.listingNumberOfDays<1)return!1;for(;m&&!a.datePeriodIsInTheFuture(m,f,g);){if((m.startDate.between(s.settings.startDate,s.settings.endDate)||m.endDate.between(s.settings.startDate,s.settings.endDate))&&(c=m.startDate.clone(),c=c.addDays(m.listingStartOffset),v=c.clone(),v=v.addDays(m.listingNumberOfDays-1),h=a.datePeriodIsCurrent(m.startDate,m.endDate,f,g,p),d()&&(y=y||n(m,h?" current":"")),t&&"function"==typeof t)){if(s.settings.highlightEventDays)for(u=new Date(m.startDate);u.compareTo(m.endDate)<=0;)o()&&t(m,u.getDate()),u.addDays(1);if(s.settings.highlightListingDays)for(u=c.clone();u.compareTo(v)<=0;)o()&&t(m,u.getDate()),u.addDays(1)}m=e.getNextEventInstance()}}},s.settings={};var g=function(){r.addClass("eventCalendar-wrap").append("<div class='eventsCalendar-list-wrap'><p class='eventsCalendar-subtitle'></p><span class='eventsCalendar-loading'>loading...</span><div class='eventsCalendar-list-content'><ul class='eventsCalendar-list'></ul></div></div>")},p=function(){s.settings.eventsScrollable&&r.find(".eventsCalendar-list-content").addClass("scrollable")},D=function(){r.find(".arrow").click(function(t){t.preventDefault();var n;e(this).hasClass("next")?(f("next"),n="-="+i):(f("prev"),n="+="+i),r.find(".eventsCalendar-monthWrap.oldMonth").animate({opacity:s.settings.moveOpacity,left:n},s.settings.moveSpeed,function(){r.find(".eventsCalendar-monthWrap.oldMonth").remove()})})},h=function(){s.settings=e.extend({},e.fn.eventCalendar.defaults,n),g(),p(),c(),f("current");var t=parseInt(r.attr("data-current-year"),10),a=parseInt(r.attr("data-current-month"),10),i=s.settings.currentDate.getDate();s.settings.initialEventList&&"day"===s.settings.initialEventList?u(s.settings.eventsLimit,t,a,i,"day"):s.settings.initialEventList&&"month"===s.settings.initialEventList?u(s.settings.eventsLimit,t,a,!1,"month"):u(s.settings.eventsLimit,!1,!1,!1,!1),D(),r.on("click",".eventsCalendar-day a",function(t){t.preventDefault();var n=parseInt(r.attr("data-current-year"),10),a=parseInt(r.attr("data-current-month"),10),s=e(this).parent().attr("rel");u(!1,n,a,s,"day")}),r.on("click",".monthTitle",function(e){e.preventDefault();var t=r.attr("data-current-year"),n=r.attr("data-current-month");u(s.settings.eventsLimit,t,n,!1,"month")}),r.find(".eventsCalendar-list").on("click",".eventTitle",function(t){if(s.settings.collapsible&&s.settings.showDescription){t.preventDefault();var n=e(this).parent().find(".eventDescription");if(!n.find("a").size()){var a=e(this).attr("href"),i=e(this).attr("target");a&&a.length>0&&n.append('<a href="'+a+'" target="'+i+'" class="bt">'+s.settings.textGoToEventUrl+"</a>")}n.is(":visible")?n.slideUp():(s.settings.onlyOneDescription&&r.find(".eventDescription").slideUp(),n.slideDown())}})};h()}a.datePeriodIsCurrent=function(e,t,n,a,s){var r=0,i=0,l=0;return n>=0&&(r+=1e4*e.getFullYear(),i+=1e4*t.getFullYear(),l+=1e4*n),a>=0&&(r+=100*e.getMonth(),i+=100*t.getMonth(),l+=100*a),s>=0&&(r+=e.getDate(),i+=t.getDate(),l+=s),l>=r&&i>=l},a.datePeriodIsInTheFuture=function(e,t,n,a){var s=e.startDate.clone();s=s.addDays(e.listingStartOffset);var r=e.startDate.isBefore(s)?e.startDate:s,i=0,l=0;return t>=0&&(i+=1e4*r.getFullYear(),l+=1e4*t),n>=0&&(i+=100*r.getMonth(),l+=100*n),a>=0&&(i+=r.getDate(),l+=a),i>l},e.fn.eventCalendar=function(t){return this.each(function(){var n=e(this);if(!n.data("eventCalendar")){var a=new s(this,t);n.data("eventCalendar",a)}})},e.fn.eventCalendar.defaults={eventsJson:"js/events.json",jsonDateFormat:"timestamp",jsonData:"",cacheJson:!0,sortAscending:!0,eventsLimit:4,dayNameFormat:"ddd",textCalendarTitle:"MMMM yyyy",textEventHeaderDayView:"MMMM ddS even\\t\\s:",textEventHeaderMonthView:"MMMM even\\t\\s:",textNoEvents:"There are no events in this period",textNext:"next",textPrevious:"prev",textNextEvents:"Next events:",textGoToEventUrl:"See the event",highlightEventDays:!0,highlightListingDays:!1,showDayAsWeeks:!0,startWeekOnMonday:!0,showDayNameInCalendar:!0,showDescription:!1,collapsible:!1,onlyOneDescription:!0,groupEvents:!1,openEventInNewWindow:!1,eventsScrollable:!1,initialEventList:!1,currentDate:Date.today(),startDate:new Date(1900,0,1,0,0,0),endDate:new Date(2999,0,1,0,0,0),allowPartialEvents:!1,moveSpeed:500,moveOpacity:.15},e.EventRecurrence=t,e.EventInstance=n,e.EventItem=a,e.EventCalendar=s}(jQuery);