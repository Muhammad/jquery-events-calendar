/*! @license: jquery.eventCalendar.js
    @author:  Jaime Fernandez (@vissit)
    @company: Paradigma Tecnologico (@paradigmate)
    @version: 0.54
    @date:    18-04-2013

    JSON data format:
        date        : event date either in timestamp format or 'YYYY-MM-DD HH:MM:SS'
        startDate   : event start date - used if event spans a number of days (defaults to date)
        endDate     : event end date - used if event spans a number of days (defaults to date)
        eventType   : single - event is on date. (default)
                               event is listed from startDate to endDate. If either are empty, date is used
                    : multi  - event lasts from startDate to endDate. If either are empty, date is used
        type        : (obsolete) event class - used to generate a class for styling
        classDetail : event class - used to generate a class for styling
        title       : event name - becomes the header line
        description : event description - becomes the detail (optionally hidden)
        url         : url of page containing event details
*/
!function(e){"use strict";e.eventCalendar=function(t,n){var a=e(t),s=this,r="300",i={},d=function(t,n,r){var i,d,o=e("<div class='eventsCalendar-slider'></div>"),v=e("<div class='eventsCalendar-monthWrap'></div>"),h=e("<div class='eventsCalendar-currentTitle'><a href='#' class='monthTitle'></a></div>"),c=e("<a href='#' class='arrow prev'><span>"+s.settings.textPrevious+"</span></a><a href='#' class='arrow next'><span>"+s.settings.textNext+"</span></a>"),u=e("<ul class='eventsCalendar-daysList'></ul>"),p=new Date;if(a.find(".eventsCalendar-slider").size()?a.find(".eventsCalendar-slider").append(v):(a.prepend(o),o.append(v)),a.find(".eventsCalendar-monthWrap.currentMonth").removeClass("currentMonth").addClass("oldMonth"),v.addClass("currentMonth").append(h,u),"current"===t)i=p.getDate(),o.append(c);else{p=new Date(a.attr("data-current-year"),a.attr("data-current-month"),1,0,0,0),i=0;var g=1;"prev"===t&&(g=-1),p.setMonth(p.getMonth()+g);var f=new Date;p.getMonth()===f.getMonth()&&(i=f.getDate())}var n=p.getFullYear(),y=(new Date).getFullYear(),r=p.getMonth();"current"!=t&&l(s.settings.eventsLimit,n,r,!1,t),a.attr("data-current-month",r).attr("data-current-year",n),h.find(".monthTitle").html(s.settings.monthNames[r]+" "+n);var D=32-new Date(n,r,32).getDate(),m=[];if(s.settings.showDayAsWeeks){u.addClass("showAsWeek");var C;if(s.settings.showDayNameInCalendar)for(u.addClass("showDayNames"),C=0,s.settings.startWeekOnMonday&&(C=1);7>C;C++)m.push('<li class="eventsCalendar-day-header">'+s.settings.dayNamesShort[C]+"</li>"),6===C&&s.settings.startWeekOnMonday&&m.push('<li class="eventsCalendar-day-header">'+s.settings.dayNamesShort[0]+"</li>");var w=new Date(n,r,1),M=w.getDay();for(s.settings.startWeekOnMonday&&(M=w.getDay()-1),0>M&&(M=6),C=M;C>0;C--)m.push('<li class="eventsCalendar-day empty"></li>')}for(d=1;D>=d;d++){var T="";i>0&&d===i&&n===y&&(T="today"),m.push('<li id="dayList_'+d+'" rel="'+d+'" class="eventsCalendar-day '+T+'"><a href="#">'+d+"</a></li>")}u.append(m.join("")),o.css("height",v.height()+"px")},l=function(t,n,r,d,l){var t=t||0,n=n||"",d=d||"";if("undefined"!=typeof r)var r=r;else var r="";a.find(".eventsCalendar-loading").fadeIn(),s.settings.jsonData?(s.settings.cacheJson=!0,i=g(s.settings.jsonData),o(i,t,n,r,d,l)):s.settings.cacheJson&&l?o(i,t,n,r,d,l):e.getJSON(s.settings.eventsjson+"?limit="+t+"&year="+n+"&month="+r+"&day="+d,function(e){i=g(e),o(i,t,n,r,d,l)}).error(function(){u("error getting json: ")}),a.find(".current").removeClass("current"),d>""&&a.find("#dayList_"+d).addClass("current")},o=function(t,n,r,i,d,l){var o="-="+s.directionLeftMove,v="auto",u=a.find(".eventsCalendar-list-wrap .eventsCalendar-subtitle");l?(""!=d?u.html(s.settings.textEventHeaderPrefix+c(d)+" "+s.settings.monthNames[i]+" "+s.settings.textEventHeaderSuffix):u.html(s.settings.textEventHeaderPrefix+s.settings.monthNames[i]+" "+s.settings.textEventHeaderSuffix),"prev"===l?o="+="+s.directionLeftMove:("day"===l||"month"===l)&&(o="+=0",v=0)):(u.html(s.settings.textNextEvents),v="auto",o="-=0"),a.find(".eventsCalendar-list").animate({opacity:s.settings.moveOpacity,left:o,height:v},s.settings.moveSpeed,function(){a.find(".eventsCalendar-list").css({left:0,height:"auto"}).hide();var l=[];if(t=e(t).sort(h),t.length){var o="";s.settings.showDescription||(o="hidden");var v="_self";s.settings.openEventInNewWindow&&(v="_target");var c=0;e.each(t,function(e,t){if((0===n||n>c)&&s.eventIsCurrent(t,r,i,d))if(i===!1&&t.eventDate<new Date);else{var h=t.eventDay+"/"+t.eventMonthToShow+"/"+t.eventYear,u=s.eventIsToday(t,r,i,d)?"current":"";if(t.url)var p='<a href="'+t.url+'" target="'+v+'" class="eventTitle '+u+'">'+t.title+"</a>";else var p='<span class="eventTitle '+u+'">'+t.title+"</span>";l.push('<li id="'+e+'" class="'+t.classDetail+'"><time datetime="'+t.eventDate+'"><em>'+h+"</em><small>"+t.eventHour+":"+t.eventMinute+"</small></time>"+p+'<div class="eventDesc '+o+'">'+t.description+"</div></li>"),c++}var g=a.find(".currentMonth .eventsCalendar-daysList");if(t.eventType===s.EventTypes.MULTI.name)for(var f=new Date(parseInt(t.startDate,10)),y=new Date(parseInt(t.endDate,10)),D=parseInt(a.attr("data-current-year"),10),m=parseInt(a.attr("data-current-month"),10);f.compareTo(y)<=0;)f.getFullYear()===D&&f.getMonth()===m&&g.find("#dayList_"+f.getDate()).addClass("dayWithEvents"),f.addDays(1);else s.eventIsCurrent(t,a.attr("data-current-year"),a.attr("data-current-month"),"")&&g.find("#dayList_"+parseInt(t.eventDay,10)).addClass("dayWithEvents")})}l.length||l.push('<li class="eventsCalendar-noEvents"><p>'+s.settings.textNoEvents+"</p></li>"),a.find(".eventsCalendar-loading").hide(),a.find(".eventsCalendar-list").html(l.join("")),s.settings.collapsible&&a.find(".eventDesc").hide(),a.find(".eventsCalendar-list").animate({opacity:1,height:"toggle"},s.settings.moveSpeed)}),f()},v=function(){a.find(".arrow").click(function(t){t.preventDefault();var n;e(this).hasClass("next")?(d("next"),n="-="+r):(d("prev"),n="+="+r),a.find(".eventsCalendar-monthWrap.oldMonth").animate({opacity:s.settings.moveOpacity,left:n},s.settings.moveSpeed,function(){a.find(".eventsCalendar-monthWrap.oldMonth").remove()})})},h=function(e,t){var n=e.eventType===s.EventTypes.MULTI.name?e.startDate:e.date,a=t.eventType===s.EventTypes.MULTI.name?t.startDate:t.date;return s.settings.sortAscending?n.toLowerCase()>a.toLowerCase()?1:-1:n.toLowerCase()<a.toLowerCase()?1:-1},c=function(e){var t,n=e.length,a=e.charAt(n-1);return t=2===n&&"1"===e.charAt(0)?"th":"1"===a?"st":"2"===a?"nd":"3"===a?"rd":"th",e+t},u=function(e){a.find(".eventsCalendar-list-wrap").html("<span class='eventsCalendar-loading error'>"+e+" "+s.settings.eventsjson+"</span>")},p=function(e,t,n,a,s){var r=0,i=0,d=0;return""!=n&&(r+=1e4*e.getFullYear(),i+=1e4*t.getFullYear(),d+=1e4*parseInt(n,10)),a!==!1&&(r+=100*e.getMonth(),i+=100*t.getMonth(),d+=100*a),""!=s&&(r+=e.getDate(),i+=t.getDate(),d+=parseInt(s,10)),d>=r&&i>=d};s.EventTypes={SINGLE:{value:0,name:"single"},MULTI:{value:1,name:"multi"}},Object.freeze&&Object.freeze(s.EventTypes),s.settings={},s.eventIsToday=function(e,t,n,a){var r=e.eventType===s.EventTypes.MULTI.name?new Date(parseInt(e.startDate,10)):new Date(parseInt(e.date,10)),i=e.eventType===s.EventTypes.MULTI.name?new Date(parseInt(e.endDate,10)):new Date(parseInt(e.date,10));return p(r,i,t,n,a)},s.eventIsCurrent=function(e,t,n,a){var s=e.startDate?new Date(parseInt(e.startDate,10)):new Date(parseInt(e.date,10)),r=e.endDate?new Date(parseInt(e.endDate,10)):new Date(parseInt(e.date,10));return p(s,r,t,n,a)};var g=function(t){return t.length&&e.each(t,function(e,t){t.eventType=!t.eventType||t.eventType.length<1?s.EventTypes.SINGLE.name:t.eventType.toLowerCase(),(!t.classDetail||t.classDetail.length<1)&&(t.classDetail=t.type),t.eventType==s.EventTypes.MULTI.name?t.endDate||(t.endDate=t.startDate):(t.startDate||(t.startDate=t.date),t.endDate||(t.endDate=t.date));var n=t.date;if((!n||n.length<1)&&(n=t.startDate),"human"==s.settings.jsonDateFormat){var a=n.split(" "),r=a[0].split("-"),i=a[1].split(":");t.eventYear=r[0],t.eventMonth=parseInt(r[1],10)-1,t.eventDay=parseInt(r[2],10),t.eventMonthToShow=parseInt(t.eventMonth,10)+1,t.eventHour=i[0],t.eventMinute=i[1],t.eventDate=new Date(t.eventYear,t.eventMonth,t.eventDay,t.eventHour,t.eventMinute,0)}else{var r=new Date(parseInt(n,10));t.eventDate=r,t.eventYear=r.getFullYear(),t.eventMonth=r.getMonth(),t.eventDay=r.getDate(),t.eventMonthToShow=t.eventMonth+1,t.eventHour=r.getHours(),t.eventMinute=r.getMinutes()}parseInt(t.eventMinute,10)<=9&&(t.eventMinute="0"+parseInt(t.eventMinute,10))}),t},f=function(){r=a.width(),a.find(".eventsCalendar-monthWrap").width(a.width()+"px"),a.find(".eventsCalendar-list-wrap").width(a.width()+"px")};s._initialiseCalendarWidth=function(){f(),e(window).resize(function(){f()})},s._initialiseContentSrolling=function(){s.settings.eventsScrollable&&a.find(".eventsCalendar-list-content").addClass("scrollable")},s._initialiseLoadingMessage=function(){a.addClass("eventCalendar-wrap").append("<div class='eventsCalendar-list-wrap'><p class='eventsCalendar-subtitle'></p><span class='eventsCalendar-loading'>loading...</span><div class='eventsCalendar-list-content'><ul class='eventsCalendar-list'></ul></div></div>")};var y=function(){s.settings=e.extend({},e.fn.eventCalendar.defaults,n),s._initialiseLoadingMessage(),s._initialiseContentSrolling(),s._initialiseCalendarWidth(),d("current");var t=a.attr("data-current-year"),r=a.attr("data-current-month"),i=new Date,o=""+i.getDate();s.settings.initialEventList&&"day"===s.settings.initialEventList?l(s.settings.eventsLimit,t,r,o,"day"):s.settings.initialEventList&&"month"===s.settings.initialEventList?l(s.settings.eventsLimit,t,r,!1,"month"):l(s.settings.eventsLimit,!1,!1,!1,!1),v(),a.on("click",".eventsCalendar-day a",function(t){t.preventDefault();var n=a.attr("data-current-year"),s=a.attr("data-current-month"),r=e(this).parent().attr("rel");l(!1,n,s,r,"day")}),a.on("click",".monthTitle",function(e){e.preventDefault();var t=a.attr("data-current-year"),n=a.attr("data-current-month");l(s.settings.eventsLimit,t,n,!1,"month")}),a.find(".eventsCalendar-list").on("click",".eventTitle",function(t){if(s.settings.collapsible&&s.settings.showDescription){t.preventDefault();var n=e(this).parent().find(".eventDesc");if(!n.find("a").size()){var r=e(this).attr("href"),i=e(this).attr("target");r&&r.length>0&&n.append('<a href="'+r+'" target="'+i+'" class="bt">'+s.settings.textGoToEventUrl+"</a>")}n.is(":visible")?n.slideUp():(s.settings.onlyOneDescription&&a.find(".eventDesc").slideUp(),n.slideDown())}})};y()},e.fn.eventCalendar=function(t){return this.each(function(){var n=e(this);if(!n.data("eventCalendar")){var a=new e.eventCalendar(this,t);n.data("eventCalendar",a)}})},e.fn.eventCalendar.defaults={eventsJson:"js/events.json",jsonDateFormat:"timestamp",jsonData:"",cacheJson:!0,sortAscending:!0,eventsLimit:4,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],textEventHeaderPrefix:"",textEventHeaderSuffix:"events:",textNoEvents:"There are no events in this period",textNext:"next",textPrevious:"prev",textNextEvents:"Next events:",textGoToEventUrl:"See the event",showDayAsWeeks:!0,startWeekOnMonday:!0,showDayNameInCalendar:!0,showDescription:!1,collapsible:!1,onlyOneDescription:!0,openEventInNewWindow:!1,eventsScrollable:!1,initialEventList:!1,currentDate:new Date,moveSpeed:500,moveOpacity:.15}}(jQuery);